# Notepad Misuse

A somewhat whimsical project to test out
[Foreign Functions and Memory functionality (project panama)](https://openjdk.org/jeps/454) introduced in
Java 22.

The objective being to perform low-level interactions with Windows APIs to get a feel for improvements over JNI.

## Proof Of Concept

![screen capture of notepad misuse](./assets/recording.gif)

## Overview

[Per Minborg's Devoxx Belgium](#foreign-functions--memory) is a great talk, introducing the language team's approach to
interacting with native code from Java. Considered delivered as of Java 22, it's good for production use now.

### Inspiration

What would be a sufficiently involved, but also time-limited project to exercise this new functionality?

* Directly interacting with processes running on windows is not your typical use-case for Java
* I've a modicum of experience reverse engineering binaries, perhaps I could patch a running process to do something
  unusual?

Out came [Ghidra](https://ghidra-sre.org) and an interesting but ultimately directionless time was spent exploring.

_What if, a program were to find the text buffer used in notepad and treat it like a screen buffer, directly injecting
updates to perform rudimentary animation?_

This would:

* require creating multiple bindings for talking to many Windows functions
* allow visual feedback
* offer fast iteration
* be essentially pointless

## Implementation

The project requires a number of Win32 calls to achieve the results. 

Broadly, the necessary steps are:
1. Hunt for a running notepad.exe process (enumerating processes, retrieving process names)
2. Inspect the process heap and search for preloaded markers to identify the text region
3. Copy memory from Java directly into the heap of the running notepad.exe process to overwrite the text edit view
4. Enumerate notepad's windows and force a refresh on a regular basis to animate frames

## Thoughts

* [jextract](https://github.com/openjdk/jextract) performed admirably. Impressed that **windows.h** didn't cause it to
  fail meaningfully
    * The code generated by jextract is a little convoluted, I chose to copy and minimmaly tidy-up the required files
    * This is a result of windows.h and its choices, other libraries would likely not require any clean-up
* The Java Record mapping classes Per refers to are a helpful abstraction. Automated generation in future will be
 useful
* Crashes and heap dumps were surprisingly infrequent. By definition there is a lot of poking around memory occurring
  and multiple LPVOID parameters to screw up - expected hazards
* Not having to create shim libraries/native methods and the associated tool-chains required is a strong win over JNI
* Speed of development, far faster iterations than under JNI
* Project Amber's reduction in boiler-plate is a pleasing addition, it's previewed in Java 22 (delivered in
  Java 23)
    * Used for a couple of ad-hoc format conversion scripts
* Predictably, I spent more time yak-shaving animations and video capture than writing FFM code...

All in all a significant improvement over JNI, would use again.

## Future Enhancements

There won't be any from me...   This is s a throwaway learning exercise. 

Before the rational part of my brain intervened though, the following ideas were circling around:

* Inject code into the running notepad process to upcall java functions, e.g animation control via the notepad menus
* notepad is soon to be replaced by Microsoft, find other programs with text view controls that can be misused similarly
* better video to ascii (well, utf) conversion - there are far more characters available than the tooling I've used,
  increase the set of characters to improve video fidelity
* synchronize music playback
* in theory other GDI would _just work_ too
* Could vsync updating be implemented? Probably not for a GDI app
* Do something similar to this program, but on a more modern applications that doesn't use GDI, render graphics rather
  than ascii
* run doom, from java, render to notepad [but it's been done in C# already](https://arstechnica.com/gaming/2022/10/how-to-get-doom-running-in-windows-notepad-exe/)

## Building

Trivial maven project, no external dependencies.

`mvn clean package` will be sufficient to create a "notepadmisuse-1.0-SNAPSHOT.jar"

### jextract

The Windows SDK needs to be installed to obtain the C++ header files.

On my system, the Windows SDK header files live in: D:\apps\WindowsSDK\Include\10.0.22621.0\um - however it's a lottery
with Windows as to where yours will end up. You are looking for "windows.h"

Original bindings generated using:

`jextract -I D:\apps\WindowsSDK\Include\10.0.22621.0\\um -I D:\apps\WindowsSDK\Include\10.0.22621.0\shared -l Kernel32 -t com.sigmaworks.ffm --output d:\development\workspaces\memoryinspector\src\main\java helper.h`

I needed to make a custom header file "helper.h" to allow psapi.h bindings to be generated. psapi.h does not directly
include windows.h, and you _really_ don't want to manually piece together windows header files piecemeal.

``` 
helper.h

#include <windows.h>
#include <psapi.h>
```

jextract produces ~5,700 files - they work but the names are a little ugly, so I've touched up what was required and
moved what was necessary to the com.sigmaworks.notepadmisuse.ffm.bindings folder.

**Note** that they are not included in the build

## Running

Latest [release](https://github.com/robjk/notepadmisuse/releases/download/release/notepadmisuse-1.0-SNAPSHOT.jar)

**If you have multiple instances of notepad.exe running, or some other process called notepad.exe, then this program has
undefined behaviour.** Perhaps just watch the screen capture if it's a concern.

Running the following command in a windows console will allow somewhat prettier emoji output:

`chcp 65001`

A Java 22 build or newer is necessary, the application is executed by:

`java --enable-preview --enable-native-access=ALL-UNNAMED -jar notepadmisuse-1.0-SNAPSHOT.jar`

There is a run script to perform both of these actions under:

`assets/run.bat`

### Notes

* The program generally fails fast, and has limited verification. You should be conscious it's hunting for
running notepad instances and directly overwriting their runtime data
* Notepad will start with the last used font selected, The "Consolas" monospace font is good choice to begin with
* You can mostly interact with the notepad instance whilst the animations are running. Don't edit (add/delete
characters, _turn word-wrap on..._) unless you're happy for it to crash (editing the text can cause the visible buffer
to move in memory, this will result in the old location continuing to be updated)
* Beyond that, go wild, change the font size (smaller = higher fidelity), or the font (try a non-monospace), alter the
zoom, highlight and copy text - _print it?!_

## Tools and inspiration

### Foreign Functions & Memory

* [Project Panama, delivered in Java 22](https://openjdk.org/jeps/454)
* [jextract, for creating boilerplate Java FFM bindings from include files](https://github.com/openjdk/jextract)
* [Per Minborg's Devoxx Belgium 2023 talk](https://youtu.be/t8c1Q2wJOoM)

### Project Amber

* [java simplification (preview 22)](https://openjdk.org/jeps/463)
    * [no-longer preview in Java 23](https://openjdk.org/jeps/477)

### Video to ASCII converter

* [media-to-ascii video to text converter](https://github.com/spoorn/media-to-ascii)

### Drizzle fade / Feistel Networks

* [Doom's drizzle fade and Feistel Networks](http://antirez.com/news/113)
* [Javascript implementation for arbitrary ranges](https://gist.github.com/edco/695435f902b187686274205527ed2fc6)

### Content

* [Toni Wilen's excellent WinUAE Amiga emulator](https://www.winuae.net)
* [the original Amiga "boing" demo](https://www.pouet.net/prod.php?which=27096)
* one of many, many [bad apple videos](https://www.youtube.com/watch?v=pyZUJ92sql8)
    * the silhouette nature of the source lends itself to lower resolution/unusual rendering
    * there is a long tradition of playing this particular video back on/in unusual places,
      e.g [marcan's laser rendering](https://www.youtube.com/watch?v=5A9Eh6D-K_g)
